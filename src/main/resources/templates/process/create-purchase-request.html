<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nueva Solicitud de Compra - BPM Consultant Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link th:href="@{/css/custom-style.css}" rel="stylesheet">
</head>
<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/process/dashboard">
                <i class="fas fa-cogs me-2"></i>BPM Consultant Demo
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/process/dashboard">
                            <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/process/create">
                            <i class="fas fa-plus me-1"></i>Nueva Solicitud
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/tasks/inbox">
                            <i class="fas fa-tasks me-1"></i>Mis Tareas
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">
                            <i class="fas fa-shopping-cart me-2"></i>
                            Nueva Solicitud de Compra
                        </h4>
                    </div>
                    <div class="card-body">
                        <form id="purchaseRequestForm" novalidate>
                            <!-- Informaci√≥n General -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <h5 class="text-primary border-bottom pb-2">
                                        <i class="fas fa-info-circle me-2"></i>Informaci√≥n General
                                    </h5>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-8">
                                    <label for="title" class="form-label">
                                        <i class="fas fa-heading me-1"></i>T√≠tulo de la Solicitud *
                                    </label>
                                    <input type="text" 
                                           class="form-control" 
                                           id="title" 
                                           name="title" 
                                           required 
                                           minlength="5" 
                                           maxlength="200"
                                           placeholder="Ej: Compra de equipos de oficina">
                                    <div class="invalid-feedback">
                                        El t√≠tulo debe tener entre 5 y 200 caracteres
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label for="priority" class="form-label">
                                        <i class="fas fa-exclamation-circle me-1"></i>Prioridad *
                                    </label>
                                    <select class="form-select" id="priority" name="priority" required>
                                        <option value="">Seleccionar...</option>
                                        <option value="LOW">Baja</option>
                                        <option value="NORMAL">Normal</option>
                                        <option value="HIGH">Alta</option>
                                        <option value="URGENT">Urgente</option>
                                    </select>
                                    <div class="invalid-feedback">
                                        Seleccione una prioridad
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="description" class="form-label">
                                    <i class="fas fa-align-left me-1"></i>Descripci√≥n Detallada *
                                </label>
                                <textarea class="form-control" 
                                          id="description" 
                                          name="description" 
                                          rows="4" 
                                          required 
                                          minlength="10" 
                                          maxlength="1000"
                                          placeholder="Describe detalladamente los productos o servicios a adquirir..."></textarea>
                                <div class="invalid-feedback">
                                    La descripci√≥n debe tener entre 10 y 1000 caracteres
                                </div>
                                <div class="form-text">
                                    <span id="descriptionCount">0</span> / 1000 caracteres
                                </div>
                            </div>

                            <!-- Informaci√≥n Financiera -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <h5 class="text-primary border-bottom pb-2">
                                        <i class="fas fa-dollar-sign me-2"></i>Informaci√≥n Financiera
                                    </h5>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="totalAmount" class="form-label">
                                        <i class="fas fa-money-bill-wave me-1"></i>Monto Total *
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" 
                                               class="form-control" 
                                               id="totalAmount" 
                                               name="totalAmount"
                                               required 
                                               min="0.01" 
                                               max="999999.99" 
                                               step="0.01"
                                               placeholder="0.00">
                                        <div class="invalid-feedback">
                                            El monto debe estar entre $0.01 y $999,999.99
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="currency" class="form-label">
                                        <i class="fas fa-coins me-1"></i>Moneda *
                                    </label>
                                    <select class="form-select" id="currency" name="currency" required>
                                        <option value="">Seleccionar moneda...</option>
                                        <option th:each="currency : ${currencies}" 
                                                th:value="${currency.code}" 
                                                th:text="${currency.symbol + ' - ' + currency.name}"
                                                th:selected="${currency.code == 'USD'}"></option>
                                    </select>
                                    <div class="invalid-feedback">
                                        Seleccione una moneda
                                    </div>
                                </div>
                            </div>

                            <!-- Informaci√≥n del Proveedor -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <h5 class="text-primary border-bottom pb-2">
                                        <i class="fas fa-truck me-2"></i>Informaci√≥n del Proveedor
                                    </h5>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="supplier" class="form-label">
                                        <i class="fas fa-building me-1"></i>Proveedor * (Datos externos)
                                    </label>
                                    <select class="form-select" id="supplier" name="supplier" required>
                                        <option value="">Cargando proveedores...</option>
                                        <option th:each="supplier : ${suppliers}" 
                                                th:value="${supplier.name}" 
                                                th:text="${supplier.name + ' (' + supplier.email + ')'}"></option>
                                    </select>
                                    <div class="invalid-feedback">
                                        Seleccione un proveedor
                                    </div>
                                    <div class="form-text">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Datos obtenidos desde servicio REST externo
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="category" class="form-label">
                                        <i class="fas fa-tags me-1"></i>Categor√≠a * (Datos externos)
                                    </label>
                                    <select class="form-select" id="category" name="category" required>
                                        <option value="">Cargando categor√≠as...</option>
                                        <option th:each="category : ${categories}" 
                                                th:value="${category.name}" 
                                                th:text="${category.name}"></option>
                                    </select>
                                    <div class="invalid-feedback">
                                        Seleccione una categor√≠a
                                    </div>
                                </div>
                            </div>

                            <!-- Fechas y Informaci√≥n Adicional -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <h5 class="text-primary border-bottom pb-2">
                                        <i class="fas fa-calendar me-2"></i>Fechas e Informaci√≥n Adicional
                                    </h5>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label for="requiredDate" class="form-label">
                                        <i class="fas fa-calendar-check me-1"></i>Fecha Requerida *
                                    </label>
                                    <input type="date" 
                                           class="form-control" 
                                           id="requiredDate" 
                                           name="requiredDate" 
                                           required>
                                    <div class="invalid-feedback">
                                        La fecha requerida debe ser futura
                                    </div>
                                </div>
                               <div class="col-md-4">
    <label for="requestor" class="form-label">
        <i class="fas fa-user me-1"></i>Solicitante *
    </label>
    <input type="text" 
           class="form-control" 
           id="requestor" 
           name="requestor" 
           required 
           cam-variable-name="requestor" 
           cam-variable-type="String">
</div>

        <div class="col-md-4">
            <label for="requestorEmail" class="form-label">
                <i class="fas fa-envelope me-1"></i>Email del Solicitante *
            </label>
            <input type="email" 
                class="form-control" 
                id="requestorEmail" 
                name="requestorEmail" 
                required 
                cam-variable-name="requestorEmail" 
                cam-variable-type="String">
        </div>

                            </div>

                            <div class="mb-3">
                                <label for="department" class="form-label">
                                    <i class="fas fa-building me-1"></i>Departamento
                                </label>
                                <select class="form-select" id="department" name="department">
                                    <option value="">Seleccionar departamento...</option>
                                    <option value="IT">Tecnolog√≠a</option>
                                    <option value="HR">Recursos Humanos</option>
                                    <option value="FINANCE">Finanzas</option>
                                    <option value="OPERATIONS">Operaciones</option>
                                    <option value="MARKETING">Marketing</option>
                                </select>
                            </div>

                            <!-- Botones de Acci√≥n -->
                            <div class="row mt-4">
                                <div class="col-12">
                                    <hr>
                                    <div class="d-flex justify-content-between">
                                        <button type="button" class="btn btn-secondary" onclick="history.back()">
                                            <i class="fas fa-arrow-left me-2"></i>Cancelar
                                        </button>
                                        <div>
                                            <button type="button" class="btn btn-outline-primary me-2" id="validateBtn">
                                                <i class="fas fa-check-circle me-2"></i>Validar Formulario
                                            </button>
                                            <button type="submit" class="btn btn-primary" id="submitBtn">
                                                <i class="fas fa-paper-plane me-2"></i>Iniciar Proceso
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmaci√≥n -->
    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-check-circle me-2"></i>Proceso Iniciado
                    </h5>
                </div>
                <div class="modal-body">
                    <div class="alert alert-success">
                        <h6><strong>¬°Solicitud creada exitosamente!</strong></h6>
                        <p class="mb-2">
                            <strong>C√≥digo:</strong> <span id="modalRequestCode"></span><br>
                            <strong>Proceso ID:</strong> <span id="modalProcessId"></span>
                        </p>
                        <p class="mb-0">
                            La solicitud ha sido enviada para su revisi√≥n y aprobaci√≥n.
                        </p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="window.location.href='/process/dashboard'">
                        <i class="fas fa-tachometer-alt me-2"></i>Ir al Dashboard
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="window.location.href='/tasks/inbox'">
                        <i class="fas fa-tasks me-2"></i>Ver Mis Tareas
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    
    <script>
        $(document).ready(function() {
            // Configurar fecha m√≠nima como ma√±ana
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const minDate = tomorrow.toISOString().split('T')[0];
            $('#requiredDate').attr('min', minDate);

            // Contador de caracteres para descripci√≥n
            $('#description').on('input', function() {
                const count = $(this).val().length;
                $('#descriptionCount').text(count);
                
                if (count > 1000) {
                    $(this).addClass('is-invalid');
                } else {
                    $(this).removeClass('is-invalid');
                }
            });

            // Validaci√≥n en tiempo real para monto
            $('#totalAmount').on('input', function() {
                const amount = parseFloat($(this).val());
                const $feedback = $(this).siblings('.invalid-feedback');
                
                if (amount > 100000) {
                    $(this).addClass('is-invalid');
                    $feedback.text('‚ö†Ô∏è Montos superiores a $100,000 requieren aprobaci√≥n especial del CEO');
                } else if (amount > 20000) {
                    $(this).removeClass('is-invalid').addClass('is-valid');
                    $feedback.text('‚ÑπÔ∏è Este monto requiere aprobaci√≥n gerencial');
                } else if (amount > 5000) {
                    $(this).removeClass('is-invalid').addClass('is-valid');
                    $feedback.text('‚ÑπÔ∏è Este monto requiere aprobaci√≥n de supervisor');
                } else if (amount <= 500 && amount > 0) {
                    $(this).removeClass('is-invalid').addClass('is-valid');
                    $feedback.text('‚úÖ Este monto puede ser aprobado autom√°ticamente');
                } else {
                    $(this).removeClass('is-invalid is-valid');
                }
            });

            // Bot√≥n de validaci√≥n
            $('#validateBtn').click(function() {
                validateForm(false);
            });

            // Env√≠o del formulario
            $('#purchaseRequestForm').submit(function(e) {
                e.preventDefault();
                
                if (validateForm(true)) {
                    submitForm();
                }
            });

            // Cargar datos externos si no est√°n disponibles
            loadExternalData();
        });

        function validateForm(showErrors) {
            let isValid = true;
            const form = document.getElementById('purchaseRequestForm');
            
            // Limpiar validaciones previas
            $(form).find('.is-invalid').removeClass('is-invalid');
            $(form).find('.is-valid').removeClass('is-valid');

            // Validar cada campo requerido
            $(form).find('[required]').each(function() {
                const $field = $(this);
                const value = $field.val().trim();
                
                if (!value) {
                    if (showErrors) $field.addClass('is-invalid');
                    isValid = false;
                } else {
                    $field.addClass('is-valid');
                }
            });

            // Validaciones espec√≠ficas
            const amount = parseFloat($('#totalAmount').val());
            if (amount <= 0 || amount > 999999.99) {
                if (showErrors) $('#totalAmount').addClass('is-invalid');
                isValid = false;
            }

            const requiredDate = new Date($('#requiredDate').val());
            const today = new Date();
            if (requiredDate <= today) {
                if (showErrors) $('#requiredDate').addClass('is-invalid');
                isValid = false;
            }

            // Mostrar resultado de validaci√≥n
            if (!showErrors) {
                if (isValid) {
                    showAlert('success', '‚úÖ Formulario v√°lido', 'Todos los campos han sido validados correctamente.');
                } else {
                    showAlert('warning', '‚ö†Ô∏è Formulario incompleto', 'Por favor, complete todos los campos requeridos.');
                }
            }

            return isValid;
        }

        // ‚úÖ CORRECCI√ìN 1: Funci√≥n submitForm() arreglada
function submitForm() {
     const $submitBtn = $('#submitBtn');
    $submitBtn.prop('disabled', true)
              .html('<i class="fas fa-spinner fa-spin me-2"></i>Procesando...');

    // ‚úÖ Extraer supplierEmail del select de proveedores
    const supplierSelect = $('#supplier');
    const selectedSupplier = supplierSelect.find('option:selected').text();
    const supplierEmail = extractEmailFromSupplierText(selectedSupplier);

    // ‚úÖ CORRECCI√ìN DE FECHA: Convertir a LocalDateTime
    const requiredDateStr = $('#requiredDate').val(); // "2025-08-02"
    const dueDate = requiredDateStr ? requiredDateStr + 'T23:59:59' : null; // "2025-08-02T23:59:59"

    // 1) Construye el objeto ‚Äúbase‚Äù
    const formData = {
      totalAmount: parseFloat($('#totalAmount').val()),
      category: $('#category').val(),
      priority: $('#priority').val(),
      requesterName: $('#requestor').val(),
      requesterEmail: $('#requestorEmail').val(),
      department: $('#department').val() || 'IT',
      description: $('#description').val(),
      currency: $('#currency').val(),
      supplierName: $('#supplier').val(),
      supplierEmail: supplierEmail,
      dueDate: dueDate
    };

    console.log('üì§ Enviando datos:', formData);
    console.assert(!isNaN(formData.totalAmount), 'totalAmount debe ser un n√∫mero');


    $.ajax({
        url: '/process/start-api',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        success: function (response) {
            console.log('‚úÖ Respuesta exitosa:', response);
            if (response.success) {
                $('#modalRequestCode').text(response.businessKey || 'N/A');
                $('#modalProcessId').text(response.processInstanceId);
                $('#confirmModal').modal('show');
            } else {
                showAlert('danger', '‚ùå Error', response.message);
            }
        },
        error: function (xhr) {
            console.error('‚ùå Error completo:', xhr);
            let errorMessage = 'Error interno del servidor';
            
            if (xhr.responseJSON && xhr.responseJSON.message) {
                errorMessage = xhr.responseJSON.message;
            } else if (xhr.responseText) {
                try {
                    const errorObj = JSON.parse(xhr.responseText);
                    errorMessage = errorObj.message || errorObj.error || xhr.responseText;
                } catch (e) {
                    errorMessage = xhr.responseText;
                }
            }
            
            showAlert('danger', '‚ùå Error', errorMessage);
        },
        complete: function () {
            $submitBtn.prop('disabled', false).html('<i class="fas fa-paper-plane me-2"></i>Iniciar Proceso');
        }
    });
}
// ‚úÖ NUEVA FUNCI√ìN: Extraer email del texto del proveedor
function extractEmailFromSupplierText(supplierText) {
    if (!supplierText) return 'noemail@supplier.com';
    const match = supplierText.match(/\(([^)]+@[^)]+)\)/);
    return match ? match[1] : 'noemail@supplier.com';
}


        // ‚úÖ CORRECCI√ìN 2: Mejorar carga de datos externos
function loadExternalData() {
    // Cargar proveedores
    if ($('#supplier option').length <= 1) {
        $.get('/api/v1/suppliers')
            .done(function(suppliers) {
                const $select = $('#supplier');
                $select.empty().append('<option value="">Seleccionar proveedor...</option>');
                suppliers.forEach(function(supplier) {
                    $select.append(`<option value="${supplier.name}" data-email="${supplier.email}">${supplier.name} (${supplier.email})</option>`);
                });
            })
            .fail(function() {
                console.warn('‚ö†Ô∏è Error cargando proveedores, usando datos de ejemplo');
                loadMockSuppliers();
            });
    }

           // Cargar categor√≠as
    if ($('#category option').length <= 1) {
        $.get('/api/v1/categories')
            .done(function(categories) {
                const $select = $('#category');
                $select.empty().append('<option value="">Seleccionar categor√≠a...</option>');
                categories.forEach(function(category) {
                    $select.append(`<option value="${category.name}">${category.name}</option>`);
                });
            })
            .fail(function() {
                console.warn('‚ö†Ô∏è Error cargando categor√≠as, usando datos de ejemplo');
                loadMockCategories();
            });
    }
}
// ‚úÖ NUEVA FUNCI√ìN: Datos de ejemplo si falla la carga externa
function loadMockSuppliers() {
    const mockSuppliers = [
        {name: 'TechCorp', email: 'ventas@techcorp.com'},
        {name: 'OfficeMax', email: 'pedidos@officemax.com'},
        {name: 'ConsultingPro', email: 'contacto@consultingpro.com'}
    ];
    
    const $select = $('#supplier');
    $select.empty().append('<option value="">Seleccionar proveedor...</option>');
    mockSuppliers.forEach(function(supplier) {
        $select.append(`<option value="${supplier.name}">${supplier.name} (${supplier.email})</option>`);
    });
}
    
   
function loadMockCategories() {
    const mockCategories = [
        {name: 'OFFICE_SUPPLIES', displayName: 'Suministros de Oficina'},
        {name: 'IT_HARDWARE', displayName: 'Hardware IT'},
        {name: 'SOFTWARE', displayName: 'Software'},
        {name: 'EQUIPMENT', displayName: 'Equipamiento'},
        {name: 'STRATEGIC', displayName: 'Estrat√©gico'},
        {name: 'CONSULTING', displayName: 'Consultor√≠a'}
    ];
    
    const $select = $('#category');
    $select.empty().append('<option value="">Seleccionar categor√≠a...</option>');
    mockCategories.forEach(function(category) {
        $select.append(`<option value="${category.name}">${category.displayName}</option>`);
    });
}
        function showAlert(type, title, message) {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    <strong>${title}</strong> ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            // Insertar alerta al inicio del formulario
            $('#purchaseRequestForm').prepend(alertHtml);
            
            // Auto-remover despu√©s de 5 segundos
            setTimeout(function() {
                $('.alert').fadeOut();
            }, 5000);
        }
    </script>
</body>
</html>